<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TradingUI — PyScript</title>
    <link rel="stylesheet" href="style.css" />

    <!-- PyScript (Pyodide) -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <!-- Plotly for browser plotting -->
    <script src="https://cdn.plot.ly/plotly-2.29.0.min.js"></script>
  </head>
  <body>
    <header>
      <h1>TradingUI (PyScript)</h1>
      <p>Run Python in the browser to fetch/download and plot historical OHLC data.</p>
    </header>

    <nav class="tabs">
      <button class="tablink active" data-target="fetch">Fetch</button>
      <button class="tablink" data-target="storage">Storage</button>
      <button class="tablink" data-target="plot">Plot</button>
    </nav>

    <main>
      <section id="fetch" class="tab active">
        <h2>Fetch</h2>
        <div class="form-row">
          <label>Symbol</label>
          <input id="symbol" value="AAPL" />
        </div>
        <div class="form-row">
          <label>Start date</label>
          <input id="start_date" type="date" />
        </div>
        <div class="form-row">
          <label>End date</label>
          <input id="end_date" type="date" />
        </div>
        <div class="form-row">
          <label>Interval</label>
          <select id="interval">
            <option value="1d">1 day</option>
            <option value="1wk">1 week</option>
            <option value="1mo">1 month</option>
            <option value="1h">1 hour</option>
            <option value="30m">30 minutes</option>
            <option value="5m">5 minutes</option>
          </select>
        </div>
        <div class="form-row">
            <button id="fetch_button" py-click="py_fetch" onclick="if(!window.pyodide) _tradingui_js_fetch()">Fetch CSV (Yahoo endpoint)</button>
          <em>Note: If the remote endpoint enforces CORS the fetch may fail — try uploading a CSV or run a local proxy.</em>
        </div>

          <div class="form-row">
            <label>API base</label>
            <input id="api_base" placeholder="/api or http://localhost:8001" value="/api" />
          </div>
          <div class="form-row">
            <label>API user</label>
            <input id="api_user" placeholder="optional username" />
            <label style="width:auto;margin-left:8px">Password</label>
            <input id="api_pass" type="password" placeholder="optional password" />
            <button id="login_button" py-click="py_login" onclick="_tradingui_js_login()">Login</button>
            <button id="logout_button" py-click="py_logout" onclick="_tradingui_js_logout()" style="margin-left:8px">Logout</button>
            <div id="login_status" style="margin-left:8px;color:var(--muted)"></div>
          </div>

        <div class="form-row">
          <label>Or upload a CSV</label>
          <input id="file_input" type="file" accept=".csv" py-change="py_upload" />
        </div>

        <div id="fetch_result"></div>
        <div id="fetch_error" style="color:#ffb4b4;margin-top:8px;font-size:13px"></div>
      </section>

      <section id="storage" class="tab">
        <h2>Storage</h2>
        <div>
          <button py-click="py_list_storage">List saved CSVs</button>
          <div id="storage_list"></div>
        </div>
      </section>

      <section id="plot" class="tab">
        <h2>Plot</h2>
        <div class="form-row">
          <label>Choose stored CSV</label>
          <select id="plot_csv_select"></select>
        </div>
        <div class="form-row">
          <label>Plot style</label>
          <select id="plot_style">
            <option value="line">Line</option>
            <option value="candlestick">Candlestick</option>
            <option value="heikinashi">Heikin-Ashi</option>
          </select>
        </div>
        <div class="form-row">
          <button py-click="py_plot_from_storage">Plot</button>
        </div>
        <div id="plot_area" style="height:480px; width:100%;"></div>
      </section>
    </main>

    <footer>
      <small>PyScript demo — network/proxy/CORS restrictions may apply when attempting to fetch remote CSVs in the browser.</small>
    </footer>

    <py-script output="fetch_result" src="tradingui_pyscript.py"></py-script>

    <script>
      // Minimal tab switching
      document.querySelectorAll('.tablink').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tablink').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.target).classList.add('active');
        });
      });

      // When index changes, populate plot CSV select by calling Python function (py_list_storage will update DOM too)
      async function refreshPlotSelect(items) {
        const sel = document.getElementById('plot_csv_select');
        sel.innerHTML = '';
        for (const name of items) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.innerText = name;
          sel.appendChild(opt);
        }
        return items.length;
      }

      // Provide JS helper for Python to call to set storage list
      window._tradingui_update_storage = function(items_str) {
        const listDiv = document.getElementById('storage_list');
        const sel = document.getElementById('plot_csv_select');
        let items = [];
        try { items = JSON.parse(items_str); } catch(e) { items = []; }
        listDiv.innerHTML = '';
        if (items.length === 0) {
          listDiv.innerText = 'No saved CSVs in localStorage';
        } else {
          const ul = document.createElement('ul');
          items.forEach(name => {
            const li = document.createElement('li');
            // name label
            const nameSpan = document.createElement('span');
            nameSpan.innerText = name + ' ';
            li.appendChild(nameSpan);

            // download button
            const dBtn = document.createElement('button');
            dBtn.type = 'button';
            dBtn.innerText = 'Download';
            dBtn.addEventListener('click', () => window._tradingui_download(name));
            li.appendChild(dBtn);

            // delete button
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.style.marginLeft = '8px';
            delBtn.innerText = 'Delete';
            delBtn.addEventListener('click', async () => {
              // confirm
              if (!confirm(`Delete saved CSV ${name}? This cannot be undone.`)) return;
              window._tradingui_delete(name);
              // update UI immediately in JS mode
              try {
                const keys = Object.keys(localStorage).filter(k => k.endsWith('.csv'));
                window._tradingui_update_storage(JSON.stringify(keys));
              } catch (e) {
                console.warn('Failed to refresh storage list after delete', e);
              }
            });
            li.appendChild(delBtn);

            ul.appendChild(li);
          });
          listDiv.appendChild(ul);
        }
        // update select
        refreshPlotSelect(items);
      }

      // JS download helper
      window._tradingui_download = function(name) {
        const csv = localStorage.getItem(name);
        if(!csv) return alert('Not found');
        const blob = new Blob([csv]);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        URL.revokeObjectURL(url);
      }

      window._tradingui_delete = function(name) {
        try {
          localStorage.removeItem(name);
        } catch (e) {
          console.warn('Failed to remove item from localStorage', e);
        }
        // Try to notify Python as well (PyScript mode) to keep Python state consistent
        if (window.pyodide) {
          try { pyodide.runPython('list_storage_and_update()'); } catch(e) { console.warn(e); }
        }
        // And always refresh storage list in JS
        try {
          const keys = Object.keys(localStorage).filter(k => k.endsWith('.csv'));
          window._tradingui_update_storage(JSON.stringify(keys));
        } catch (e) { /* ignore */ }
      }
      // JS fallback: make the Fetch button always work (in case PyScript fails to load)
      async function _tradingui_js_fetch() {
        const out = document.getElementById('fetch_result');
        const sym = document.getElementById('symbol').value.trim();
        const sd = document.getElementById('start_date').value;
        const ed = document.getElementById('end_date').value;
        if (!sym) { out.innerText = 'Please enter a symbol'; return; }

        const apiBase = (document.getElementById('api_base') && document.getElementById('api_base').value.trim()) || '';
        let urls = [];
        const base = apiBase.replace(/\/$/, '') || '';
        const interval = document.getElementById('interval')?.value || '';
        if (sd && ed) {
          urls = [
            `${base}/download?symbol=${encodeURIComponent(sym)}&start=${encodeURIComponent(sd)}&end=${encodeURIComponent(ed)}${interval?`&interval=${encodeURIComponent(interval)}`:''}`,
            `http://localhost:8001/api/download?symbol=${encodeURIComponent(sym)}&start=${encodeURIComponent(sd)}&end=${encodeURIComponent(ed)}${interval?`&interval=${encodeURIComponent(interval)}`:''}`
          ];
        } else {
          urls = [
            `${base}/download?symbol=${encodeURIComponent(sym)}&period=1y${interval?`&interval=${encodeURIComponent(interval)}`:''}`,
            `http://localhost:8001/api/download?symbol=${encodeURIComponent(sym)}&period=1y${interval?`&interval=${encodeURIComponent(interval)}`:''}`
          ];
        }

        out.innerText = 'Fetching...';
        let text = null;
        // build headers if credentials supplied
        let headers = {};
        const u = document.getElementById('api_user')?.value || '';
        const p = document.getElementById('api_pass')?.value || '';
        if (u && p) {
          headers['Authorization'] = 'Basic ' + btoa(`${u}:${p}`);
        }

        for (const url of urls) {
          try {
            const r = await fetch(url, { headers });
            if (r.ok) { text = await r.text(); break; }
            console.warn('proxy returned', r.status, 'for', url);
          } catch (err) {
            console.warn('fetch error for', url, err);
          }
        }

        if (!text) {
          out.innerText = 'Fetch failed — proxy and direct fetch attempts failed (CORS or network).';
          // show a helpful hint about origins and credentials
          const err = document.getElementById('fetch_error');
          let hint = 'If you are running the UI from a different host/port ensure the API allows this origin. Configure TRADINGUI_API_ALLOW_ORIGINS to include ' + window.location.origin + '.';
          if (u && p) hint += ' If using Basic Auth, ensure credentials are correct and the API is reachable.';
          if (err) err.innerText = hint;
          return;
        }

        // Save to localStorage like PyScript would
        const name = `${sym}_${new Date().toISOString().replace(/[:.]/g,'')}.csv`;
        try {
          localStorage.setItem(name, text);
          out.innerText = `Saved ${name} to localStorage`;
          // update storage UI
          try { window._tradingui_update_storage(JSON.stringify(Object.keys(localStorage).filter(k=>k.endsWith('.csv')))); } catch(e){}
        } catch (err) {
          out.innerText = `Failed saving CSV to localStorage: ${err}`;
        }
      }

      // wire the send button to JS fallback too
      document.addEventListener('DOMContentLoaded', () => {
        const b = document.getElementById('fetch_button');
        if (b) {
          b.addEventListener('click', (ev) => {
            // If PyScript runtime is present, it will handle py-click; this is a safe fallback
            // that will run when py-fetch doesn't call or if pyodide is not available.
            setTimeout(() => {
              // only run fallback if the PyScript target didn't write to the output within 300ms
              const out = document.getElementById('fetch_result');
              if (!out || out.innerText.trim() === '' || out.innerText.includes('Fetching')) {
                _tradingui_js_fetch();
              }
            }, 300);
          });
        }
      });

        // expose simple JS login/logout for when PyScript isn't available
        window._tradingui_js_login = function() {
          const u = document.getElementById('api_user')?.value || '';
          const p = document.getElementById('api_pass')?.value || '';
          if (!u || !p) {
            alert('Enter username and password before clicking Login');
            return;
          }
          try {
            sessionStorage.setItem('tradingui_api_user', u);
            sessionStorage.setItem('tradingui_api_pass', p);
            const status = document.getElementById('login_status');
            if (status) status.innerText = `Logged in as ${u}`;
          } catch (e) { console.warn('sessionStorage not available', e); }
        }

        window._tradingui_js_logout = function() {
          try {
            sessionStorage.removeItem('tradingui_api_user');
            sessionStorage.removeItem('tradingui_api_pass');
            const status = document.getElementById('login_status');
            if (status) status.innerText = 'Logged out';
          } catch (e) { console.warn('sessionStorage not available', e); }
        }

        // on load, show login state if present
        try {
          const su = sessionStorage.getItem('tradingui_api_user');
          if (su) {
            const status = document.getElementById('login_status');
            if (status) status.innerText = `Logged in as ${su}`;
          }
        } catch(e) { /* ignore */ }
    </script>
  </body>
</html>
